<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Roboto:900" rel="stylesheet">
        <link rel="stylesheet" href="assets/css/style.css">
        <title>GifTastic</title>
    </head>
    <body>
        <div class="container-fluid">
            <canvas id="hero-canvas">
                GifTastic
            </canvas>
        </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
    <script src="assets/js/perlin.js" charset="utf-8"></script>
    <script src="assets/js/bitmaps.js" charset="utf-8"></script>
    <script type="text/javascript">
        var P, title, pixelSize;
        var heroCanvas, heroContext;
        var t, lastDrawTime;
        var lastResize, resizeTimeout, resizeInterval;

        function UpdateTitle() {
            var windowWidth = $(window).width();
            var fontsize = 14;
            pixelSize = 10;
            heroCanvas.height = 200;
            if (windowWidth < 900) { fontsize = 12; }
            if (windowWidth < 750) { fontsize = 10; }
            if (windowWidth < 650) { fontsize = 9; }
            if (windowWidth < 600) { fontsize = 8; }
            if (windowWidth < 500) { fontsize = 14; pixelSize = 5; heroCanvas.height = 100; }
            if (windowWidth < 400) { fontsize = 12; }
            if (windowWidth < 420) { fontsize = 11; }
            title = UpscaleCanvas(GetTitleBitmap(90, 20, fontsize, 255, "GIFTASTIC", 128), pixelSize);
        };

        function DrawHeader(canvas, t) {
            var ctx = canvas.getContext("2d");
            var pWidth = Math.floor(canvas.width/pixelSize);
            var pHeight = Math.floor(canvas.height/pixelSize);
            var pImg = P.colorImage(pWidth, pHeight, 80/pixelSize, t);
            ctx.drawImage(UpscaleCanvas(pImg, pixelSize), 0, 0);
            var titleX = Math.floor(Math.floor((canvas.width-title.width)*0.5)/pixelSize)*pixelSize;
            ctx.drawImage(title, titleX, 0);
        };

        function DrawLoop() {
            var delta = Date.now() - lastDrawTime;
            heroContext.clearRect(0, 0, heroCanvas.width, heroCanvas.height);
            DrawHeader(heroCanvas, t);
            t += delta*0.0001;
            lastDrawTime += delta;
            requestAnimationFrame(DrawLoop);
        };

        $(document).ready(function() {
            P = new Perlin();
            title;
            pixelSize = 10;

            heroCanvas = $("#hero-canvas")[0];
            heroCanvas.width = heroCanvas.clientWidth;
            heroCanvas.height = heroCanvas.clientHeight;
            heroContext = heroCanvas.getContext("2d");
            UpdateTitle();
            setTimeout(UpdateTitle, 1000);
            t = 0;
            lastDrawTime = Date.now();
            DrawLoop();

            lastResize = Date.now();
            resizeTimeout = 0;
            resizeInterval = 250;
            $(window).resize(function() {
                resizeTimeout = setTimeout(function() {
                    if (Date.now() - lastResize < resizeInterval) { return; }
                    lastResize = Date.now();
                    // Update heroCanvas size
                    heroCanvas.width = heroCanvas.clientWidth;
                    UpdateTitle();
                    DrawHeader(heroCanvas, t);
                }, resizeInterval);
                if (Date.now() - lastResize < resizeInterval) {
                    clearTimeout(resizeTimeout);
                }
            });
        });
    </script>
    </body>
</html>
